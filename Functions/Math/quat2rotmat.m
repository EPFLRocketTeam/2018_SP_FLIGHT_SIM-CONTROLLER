function C = quat2rotmat(q)
% QUAT2ROTMAT computes the rotation matrix equivalent to quaternion q (4xn).
% q represents the attitude of the vehicle in earth's cartesian coordinate
% system. The resulting matrix C (3x3xn) rotates the coordinate system proper 
% to the vehicle into earth's coordinate system.

q1 = q(1,:); q2 = q(2,:); q3 = q(3,:); q4 = q(4,:);

C = reshape([1-2*q2.^2-2*q3.^2;...
    2*(q1.*q2 + q3.*q4);...
    2*(q1.*q3 - q2.*q4);...
    2*(q1.*q2 - q3.*q4);...
    1-2*q1.^2-2*q3.^2;...
    2*(q2.*q3 + q1.*q4);...
    2*(q1.*q3 + q2.*q4);...   
    2*(q2.*q3 - q1.*q4);...   
    1-2*q1.^2 - 2*q2.^2]...
    , 3, 3, []);
end